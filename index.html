<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <title>Court File Tracker</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Top Header -->
  <header class="topbar">
    <button id="menuBtn" aria-label="Toggle Sidebar">‚ò∞</button>
    <div class="top-title">
      <h1>Court File Tracker</h1>
      <p>Smart Solutions for Efficient Record Management</p>
    </div>
    <button id="installBtn" style="display:none;" aria-label="Install App">Install App</button>
  </header>

  <!-- Main App Container -->
  <div class="app-container">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-overlay"></div>
      <img src="icon-192.png" alt="CFT Logo" class="sidebar-logo" />
      <nav>
        <button data-screen="dashboard" aria-label="Dashboard"><span>üè†</span> Dashboard</button>
        <button data-screen="newFile" aria-label="New Entry"><span>üìÇ</span> New Entry</button>
        <button data-screen="return" aria-label="Return File"><span>‚Ü©Ô∏è</span> Return File</button>
        <button data-screen="fileFetcher" aria-label="File Fetcher"><span>üë§</span> File Fetcher</button>
        <button data-screen="admin" aria-label="Admin"><span>üõ°Ô∏è</span> Admin</button>
        <button data-screen="developersDisclaimer" aria-label="Developers Disclaimer"><span>‚ÑπÔ∏è</span> Developers Disclaimer</button>
      </nav>
    </aside>

    <!-- Main Screens -->
    <main>
      <!-- Dashboard -->
      <section id="dashboard" class="screen">
        <h2>Dashboard Summary</h2>
        <div id="dashboardStats" style="margin-bottom: 20px;">
          <canvas id="statsChart" height="100"></canvas>
        </div>
        <div id="dashboardCards" class="dashboard-grid">
          <div class="card card-deliveries" id="cardDeliveries" aria-label="Files delivered today">
            <span class="tooltip">Files delivered today</span>
          </div>
          <div class="card card-returns" id="cardReturns" aria-label="Files returned today">
            <span class="tooltip">Files returned today</span>
          </div>
          <div class="card card-pending" id="cardPending" aria-label="Files not yet returned">
            <span class="tooltip">Files not yet returned</span>
          </div>
          <div class="card card-tomorrow" id="cardTomorrow" aria-label="Hearings scheduled for tomorrow">
            <span class="tooltip">Hearings scheduled for tomorrow</span>
          </div>
          <div class="card card-overdue" id="cardOverdue" aria-label="Files pending over 10 days">
            <span class="tooltip">Files pending over 10 days</span>
          </div>
          <div class="card card-search-prev" id="cardSearchPrev" aria-label="Search all previous records">
            <span class="tooltip">Search all previous records</span>
          </div>
        </div>

        <div id="dashboardReportPanel" style="display:none; margin-top: 20px;">
          <div id="loadingIndicator" class="loading" style="display:none;">Loading...</div>
          <h3 id="reportTitle"></h3>
          <div id="searchPrevRecords" style="display:none; margin-bottom: 10px;">
            <div class="search-container">
              <label>Title:
                <input type="text" id="searchTitle" placeholder="A Vs. B" aria-label="Search by Title" />
              </label>
              <label>CMS No:
                <input type="number" id="searchCms" aria-label="Search by CMS Number" />
              </label>
              <label>File Taker:
                <div class="input-container">
                  <input type="text" id="searchFileTaker" autocomplete="off" aria-label="Search by File Taker" />
                  <ul id="searchSuggestions"></ul>
                </div>
              </label>
              <label>FIR No:
                <input type="text" id="searchFirNo" aria-label="Search by FIR Number" />
              </label>
              <label>FIR Year:
                <input type="number" id="searchFirYear" aria-label="Search by FIR Year" />
              </label>
              <label>Police Station:
                <input type="text" id="searchPoliceStation" aria-label="Search by Police Station" />
              </label>
            </div>
          </div>
          <button onclick="printDashboardReport()" aria-label="Print Report">Print</button>
          <button onclick="exportDashboardReport('csv')" aria-label="Export to CSV">Export to CSV</button>
          <button onclick="exportDashboardReport('pdf')" aria-label="Export to PDF">Export to PDF</button>
          <div class="table-container">
            <table id="dashboardReportTable" border="1" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th>Sr#</th>
                  <th>CMS No</th>
                  <th>Title</th>
                  <th>Case Type</th>
                  <th>Nature</th>
                  <th>Criminal Details</th>
                  <th>Date Type</th>
                  <th>Swal Form Details</th>
                  <th>Delivered To</th>
                  <th>Delivery Date</th>
                  <th>Return Date</th>
                  <th>Time Span</th>
                  <th>Court</th>
                  <th>Clerk Name</th>
                  <th>Profile Details</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="pagination" style="margin-top: 10px; text-align: center;">
            <button id="prevPage" disabled aria-label="Previous Page">Previous</button>
            <span id="pageInfo"></span>
            <button id="nextPage" aria-label="Next Page">Next</button>
          </div>
        </div>
      </section>

      <!-- New File Entry -->
      <section id="newFile" class="screen">
        <h2>New File Entry & Delivery</h2>
        <div id="loadingIndicator" class="loading" style="display:none;">Saving...</div>
        <form id="fileForm">
          <label>Case Type: <span class="required">*</span>
            <select id="caseType" required aria-label="Case Type">
              <option value="">Select</option>
              <option value="civil">Civil</option>
              <option value="criminal">Criminal</option>
            </select>
          </label>
          <label>CMS No: <span class="required">*</span>
            <input type="number" id="cmsNo" required aria-label="CMS Number" />
          </label>
          <label>Petitioner: <span class="required">*</span>
            <input type="text" id="petitioner" required aria-label="Petitioner" />
          </label>
          <label>Respondent: <span class="required">*</span>
            <input type="text" id="respondent" required aria-label="Respondent" />
          </label>
          <label>Nature of Case: <span class="required">*</span>
            <input type="text" id="nature" required aria-label="Nature of Case" />
          </label>
          <div id="criminalFields" style="display:none">
            <label>FIR No: <input type="text" id="firNo" aria-label="FIR Number" /></label>
            <label>FIR Year: <input type="number" id="firYear" min="1947" aria-label="FIR Year" /></label>
            <label>FIR U/S: <input type="text" id="firUs" aria-label="FIR U/S" /></label>
            <label>Police Station: <input type="text" id="policeStation" aria-label="Police Station" /></label>
          </div>
          <label>Date Type: <span class="required">*</span>
            <select id="dateType" required aria-label="Date Type">
              <option value="">Select</option>
              <option value="decision">Decision Date</option>
              <option value="hearing">Next Hearing Date</option>
            </select>
          </label>
          <label>Date: <span class="required">*</span>
            <input type="date" id="date" required aria-label="Date" />
          </label>
          <div class="input-container">
            <label>Delivered To (Name): <span class="required">*</span>
              <input type="text" id="deliveredTo" required autocomplete="off" aria-label="Delivered To" />
              <ul id="suggestions"></ul>
              <span class="hint" style="font-size:12px;color:#555;">Edit profiles in the File Fetcher section.</span>
            </label>
          </div>
          <label>Delivered To Type: <span class="required">*</span>
            <select id="deliveredType" required aria-label="Delivered To Type">
              <option value="">Select</option>
              <option value="munshi">Munshi/Clerk</option>
              <option value="advocate">Advocate</option>
              <option value="colleague">Colleague</option>
              <option value="other">Other</option>
            </select>
          </label>
          <div class="copy-agency-row">
            <input type="checkbox" id="copyAgency" aria-label="Sent to Copy Agency" />
            <label for="copyAgency">Sent to Copy Agency</label>
          </div>
          <div id="copyAgencyFields" style="display:none;">
            <label>Swal Form No: <span class="required">*</span>
              <input type="number" id="swalFormNo" aria-label="Swal Form Number" />
            </label>
            <label>Swal Date: <span class="required">*</span>
              <input type="date" id="swalDate" aria-label="Swal Date" />
            </label>
          </div>
          <button type="submit" aria-label="Save and Deliver File">Save and Deliver File</button>
        </form>
      </section>

      <!-- Return -->
      <section id="return" class="screen">
        <h2>Return File</h2>
        <div id="loadingIndicator" class="loading" style="display:none;">Loading...</div>
        <form id="returnForm">
          <label>CMS No: <input type="number" id="returnCms" aria-label="CMS Number" /></label>
          <label>Title: <input type="text" id="returnTitle" aria-label="Title" /></label>
        </form>
        <div id="pendingFiles" style="margin-top: 10px;">
          <table id="pendingFilesTable" border="1" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>Select</th>
                <th>CMS No</th>
                <th>Title</th>
                <th>Case Type</th>
                <th>Delivered To</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button onclick="bulkReturnFiles()" style="margin-top: 10px;" aria-label="Return Selected Files">Return Selected</button>
        </div>
      </section>

      <!-- File Fetcher -->
      <section id="fileFetcher" class="screen">
        <h2>File Fetcher</h2>
        <div id="loadingIndicator" class="loading" style="display:none;">Loading...</div>
        <div class="fetcher-grid">
          <button class="card card-add-profile" onclick="showProfileForm()" aria-label="Add New Profile">Add New Profile</button>
          <button class="card card-search-profiles" onclick="showProfileSearch()" aria-label="Search Existing Profiles">Search Existing Profiles</button>
          <button class="card card-import" onclick="triggerImport()" aria-label="Import Profiles">Import Profiles</button>
          <button class="card card-export" onclick="exportProfiles()" aria-label="Export Profiles">Export Profiles</button>
        </div>
        <input type="file" id="profileImport" accept=".json" style="display:none;" />
        <form id="profileForm" style="display:none; margin-top:20px;">
          <label>Profile Type: <span class="required">*</span>
            <select id="profileType" required aria-label="Profile Type">
              <option value="">Select</option>
              <option value="munshi">Munshi/Clerk</option>
              <option value="advocate">Advocate</option>
              <option value="colleague">Colleague</option>
              <option value="other">Other</option>
            </select>
          </label>
          <div id="profileFields"></div>
          <label>Upload Photo: <span id="photoRequired" class="required">*</span>
            <input type="file" id="profilePhoto" accept="image/*" aria-label="Upload Profile Photo" />
          </label>
          <img id="photoPreview" style="display: none; max-width: 200px;" alt="Profile Photo Preview" />
          <div id="photoAdjust"></div>
          <button type="submit" aria-label="Add or Update Profile">Add/Update Profile</button>
        </form>
        <div id="profileSearchSection" style="display:none; margin-top:20px;">
          <label>Filter by Type:
            <select id="profileFilterType" aria-label="Filter by Profile Type">
              <option value="">All</option>
              <option value="munshi">Munshi/Clerk</option>
              <option value="advocate">Advocate</option>
              <option value="colleague">Colleague</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>Search: <input type="text" id="profileSearch" placeholder="Name, number, chamber..." aria-label="Search Profiles" /></label>
        </div>
        <div id="profileList" style="margin-top:20px; display:none;">
          <table id="profileTable" border="1" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>Photo</th>
                <th>Name</th>
                <th>Type</th>
                <th>Cell No</th>
                <th>Chamber No</th>
                <th>Files Delivered</th>
                <th>Pending Files</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Admin -->
      <section id="admin" class="screen active">
        <h2>Admin</h2>
        <div id="loadingIndicator" class="loading" style="display:none;">Saving...</div>
        <div id="setupMessage" style="display:block; color: #0066cc; margin-bottom: 10px;">
          Please complete your profile setup to continue using the app.
        </div>
        <div id="savedProfile" style="display:none; background:white; padding:20px; border-radius:10px; max-width:600px; margin:auto;">
          <h3>Saved Profile</h3>
          <table class="profile-table">
            <tr><th>Photo</th><td><img id="savedUserPhoto" src="" style="width:120px;height:120px;border-radius:50%;border:1px solid #ccc;display:none;" alt="User Photo" /></td></tr>
            <tr><th>Name</th><td><span id="savedClerkName"></span></td></tr>
            <tr><th>Designation</th><td><span id="savedJudgeName"></span></td></tr>
            <tr><th>Court</th><td><span id="savedCourtName"></span></td></tr>
            <tr><th>Mobile</th><td><a id="savedMobile" href=""></a></td></tr>
            <tr><th>Total Files</th><td><span id="totalFiles"></span></td></tr>
            <tr><th>Total Profiles</th><td><span id="totalProfiles"></span></td></tr>
          </table>
          <button onclick="editUserProfile()" aria-label="Edit Profile">Edit Profile</button>
          <button onclick="showChangePin()" aria-label="Change PIN">Change PIN</button>
          <h4>Data Management</h4>
          <button onclick="backupData()" aria-label="Backup to Local">Backup to Local</button>
          <button onclick="triggerRestore()" aria-label="Restore from Local">Restore from Local</button>
          <button onclick="resetApp()" aria-label="Reset App">Reset App</button>
        </div>
        <input type="file" id="dataRestore" accept=".json" style="display:none;" />
        <form id="adminForm" style="display:block;">
          <label>Full Name: <span class="required">*</span>
            <input type="text" id="clerkName" required aria-label="Full Name" />
          </label>
          <label>Designation: <span class="required">*</span>
            <input type="text" id="judgeName" required aria-label="Designation" />
          </label>
          <label>Court Name: <span class="required">*</span>
            <input type="text" id="courtName" required aria-label="Court Name" />
          </label>
          <label>Mobile Number: <span class="required">*</span>
            <input type="text" id="mobile" required placeholder="0300-1234567" aria-label="Mobile Number" />
          </label>
          <label>CNIC: <span class="required">*</span>
            <input type="text" id="cnic" required placeholder="XXXXX-XXXXXXX-X" aria-label="CNIC" />
            <span class="tooltip">?
              <span class="tooltiptext">CNIC is required to reset your PIN securely. It is not stored externally.</span>
            </span>
          </label>
          <label>PIN (4 digits): <span class="required">*</span>
            <input type="password" id="pin" maxlength="4" pattern="\d{4}" required aria-label="PIN" />
          </label>
          <label>Email (for PIN recovery):
            <input type="email" id="email" placeholder="example@domain.com" aria-label="Email" />
          </label>
          <label>Upload Photo: <span class="required">*</span>
            <input type="file" id="userPhoto" accept="image/*" required aria-label="Upload User Photo" />
          </label>
          <img id="userPhotoPreview" style="display: none; max-width: 200px;" alt="User Photo Preview" />
          <div id="userPhotoAdjust"></div>
          <label><input type="checkbox" id="agreeTerms" aria-label="Agree to Terms"> I agree to the <a href="#" onclick="showDisclaimerModal()">terms and privacy policy</a>.</label>
          <button type="submit" id="saveProfileBtn" disabled aria-label="Save Profile">Save</button>
        </form>
      </section>

      <!-- Developers Disclaimer -->
      <section id="developersDisclaimer" class="screen">
        <h2>Developers Disclaimer</h2>
        <div id="disclaimerContent">
          <p>This Court File Tracker (CFT) PWA is developed to assist court clerks and judiciary staff in managing file records efficiently. It is not an official judiciary tool. Users are responsible for ensuring data accuracy and compliance with legal standards.</p>
          <p>Developer: [Your Name]</p>
          <p>Contact: [Your Email or Placeholder]</p>
          <p>Version: 1.0.0</p>
          <p>Last Updated: May 15, 2025</p>
        </div>
      </section>

      <!-- PIN Prompt Modal -->
      <div id="pinModal" class="modal">
        <div class="modal-content">
          <h3>Enter PIN</h3>
          <input type="password" id="pinInput" maxlength="4" pattern="\d{4}" style="padding:8px; width:100%;" aria-label="Enter PIN" />
          <button onclick="submitPin()" aria-label="Submit PIN">Submit</button>
        </div>
      </div>

      <!-- Change PIN Modal -->
      <div id="changePinModal" class="modal">
        <div class="modal-content">
          <h3>Change PIN</h3>
          <label>CNIC or Email: <input type="text" id="resetCnic" placeholder="Enter CNIC or Email" required aria-label="CNIC or Email" /></label>
          <label>New PIN: <input type="password" id="resetPin" maxlength="4" pattern="\d{4}" required aria-label="New PIN" /></label>
          <button onclick="changePin()" aria-label="Change PIN">Change</button>
          <button onclick="hideChangePin()" aria-label="Cancel">Cancel</button>
        </div>
      </div>

      <!-- Disclaimer Modal -->
      <div id="disclaimerModal" class="modal">
        <div class="modal-content">
          <h3>Disclaimer & Privacy Policy</h3>
          <p><strong>Disclaimer:</strong> This is not an official judiciary tool. It is designed for the convenience of clerks and judiciary staff to digitize record-keeping. Users are responsible for their use of this tool.</p>
          <p><strong>Privacy Policy:</strong> Your data is saved locally in your browser. No data is stored externally by the app.</p>
          <button onclick="document.getElementById('disclaimerModal').style.display='none';" aria-label="Close Disclaimer">Close</button>
        </div>
      </div>

      <!-- Profile Details Modal -->
      <div id="profileModal" class="modal">
        <div class="modal-content">
          <h3 id="profileModalTitle"></h3>
          <div style="position: relative; display: inline-block;">
            <img id="profileModalPhoto" src="" style="width:100px;height:100px;border-radius:50%;border:1px solid #ccc;margin-bottom:10px;display:none;" alt="Profile Photo" />
            <div class="photo-zoom" style="display:none; position:absolute; top:0; left:110px; z-index:10;">
              <img id="profileModalPhotoZoom" src="" style="width:200px;height:200px;border-radius:10px;border:2px solid #ccc;" alt="Zoomed Profile Photo" />
            </div>
          </div>
          <table id="profileModalTable" class="profile-modal-table"></table>
          <button onclick="closeProfileModal()" aria-label="Close Profile Details">Close</button>
        </div>
      </div>

      <!-- Toast Notification -->
      <div id="toast" class="toast" style="display:none;"></div>
    </main>
  </div>

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <script src="app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(() => console.log("Service Worker registered"));
      });
    }
  </script>
</body>
</html>
